<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=1024, user-scalable=no">

  <title>Your deck.js Presentation</title>

  <!-- Required stylesheet -->
  <link rel="stylesheet" media="screen" href="core/deck.core.css">

  <!-- Extension CSS files go here. Remove or add as needed. -->
  <link rel="stylesheet" media="screen" href="extensions/goto/deck.goto.css">
  <link rel="stylesheet" media="screen" href="extensions/menu/deck.menu.css">
  <link rel="stylesheet" media="screen" href="extensions/navigation/deck.navigation.css">
  <link rel="stylesheet" media="screen" href="extensions/status/deck.status.css">
  <link rel="stylesheet" media="screen" href="extensions/scale/deck.scale.css">

  <!-- Style theme. More available in /themes/style/ or create your own. -->
  <link rel="stylesheet" media="screen" href="themes/style/swiss.css">

  <!-- Transition theme. More available in /themes/transition/ or create your own. -->
  <link rel="stylesheet" media="screen" href="themes/transition/horizontal-slide.css">

  <!-- Basic black and white print styles -->
  <link rel="stylesheet" media="print" href="core/print.css">

        <link href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.26.0/codemirror.min.css' rel='stylesheet' />
        <link href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.33.0/theme/duotone-light.min.css' rel='stylesheet' />
        <link href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.33.0/theme/monokai.min.css' rel='stylesheet' />
        <link href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.33.0/theme/base16-light.min.css' rel='stylesheet' />
        <link href='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.33.0/theme/neat.min.css' rel='stylesheet' />

        <style>

            .editor {
                width: 100%;
                margin-bottom: 15px !important;
            }

            .wrapper {
                display:inline-block;
                position:relative;
            }

            .wrapper .hidden {
                display:none;
            }

            .wrapper button{
             position:absolute;
             top:4px;
             right:4px;
             z-index: 100;
             height: 25px;
             width: 25px;
             background-image: url(https://png.icons8.com/metro/1600/play.png);
             background-repeat: no-repeat;
             background-position: center;
             background-size: cover;
            }

            .CodeMirror {
                height: auto;
                font-family: Courier, monospace !important;
                font-size: 20px !important;
                font-weight: 700 !important;
                background-color: #eee
            }

        </style>

  <!-- Required Modernizr file -->
  <script src="modernizr.custom.js"></script>
</head>
<body>
  <div class="deck-container">

    <!-- Begin slides. Just make elements with a class of slide. -->


    <section class="slide">
<h2>GEOPROCESSING IN SQL</h2>
<h2>ESTATE GIS - MASTER IN GIS-SCIENCE E DRONI</h2>

<p>Enrico Ferreguti enricofer@gmail.com<P>

<div class ='wrapper editor'>
<textarea class="code" id='code' name='code'>
SELECT AsGeoJSON(ST_Union(comuni.geom)) AS geojson
FROM comuni, ferrovie
WHERE  st_intersects (comuni.geom,ferrovie.geom)
</textarea>
<button class="hidden"></button>
</div>
</section>



<section class="slide">
  <h2>Database relazionali</h2>
  <p>Un database relazionale è fondamentalmente una raccolta di tabelle organizzata in modo da evitare la ridondanza dei dati e permettere di relazioni logiche tra i dati.</p>

  <img src="https://www.okpedia.it/data/okpedia/database-relazionale-esempio.gif">

  <p>In un database convenzionale le varie tabelle sono collegate tra loro da chiavi (*keys*) che permettono di collegare *record* e *campi* delle varie tabelle</p>
</section>

    <section class="slide">
      <h2>SQL</h2>
      <p>Il sistema che gestisce il database relazionale si chiama RDBMS *Relational DataBase Management System* e può essere monoutente, orientato alla manipolazione personale di dati (Access, Sqlite) o multiutente, basato su server, con complessa gestione</p>
      <p>SQL  è un acronimo che significa *Structured Query Language* ed è un linguaggio ideato negli anni '70  per accedere ed amministrare database relazionali e pur declinato in molti dialetti è diventato uno standard</p>
    </section>

    <section class="slide">
      <h2>SPATIAL DATABASE</h2>
      <p>Un database spaziale è un database convenzionale a cui sono associate le informazioni spaziale in un campo che per definizione chiamiamo *geometria*.</p>
      <p>A tutt'oggi i più diffusi DBMS, sia  dispongono di estensioni per la manipolazione spaziale dei dati che permettono di:</p>
      <ul>
        <li>localizzare geograficamente il dato</li>
        <li>mettere in relazione spaziale i dati</li>
        <li>misurare il dato nella sua estensione spaziale</li>
      </ul>
    </section>

    <section class="slide">
      <h2>GIS vs SPATIAL DATABASE</h2>
      <p>Adoperando un sistema GIS stiamo di fatto usando un database spaziale, Perchè dunque usare un database al posto del GIS per manipolare dati spaziali:</p>
      <ul>
        <li>Consente la gestione più agevole di grandi quantità di dati (Big data)</li>
        <li>Consente una maggiore velocità di elaborazione (è tralasciata l'interfaccia grafica)</li>
        <li>Consente una più agevole relazione tra i dati</li>
        <li>Si evita di replicare i dati (scrivendo query si evita di esportare tabelle non necessarie)</li>
        <li>I dati sono più facili da riusare (webgis)</li>
      </ul>
    </section>

    <section class="slide">
      <h2>SINTASSI SQL</h2>
      <p>In linguaggio SQL sono possibili parecchi tipi di Query:</p>
      <p>query di creazione tabella:</p>
      <div class ='wrapper editor'>
      <textarea class="code" id='code1' name='code'>
      CREATE TABLE tab(id INT PRIMARY KEY NOT NULL, campo1 CHAR(50), campo2 INT);
      </textarea>
      <button class="hidden"></button>
      </div>
      <p>query di inserimento dati:</p>
      <div class ='wrapper editor'>
      <textarea class="code" id='code2' name='code'>
      INSERT INTO tab (id, campo1, campo2) VALUES (1, 'valore 1', 120);
      </textarea>
      <button class="hidden"></button>
      </div>
      <p>query di cancellazione tabella:</p>
      <div class ='wrapper editor'>
      <textarea class="code" id='code3' name='code'>
      DROP TABLE tab;
      </textarea>
      <button class="hidden"></button>
      </div>
      <p>query di aggiornamento:</p>
      <div class ='wrapper editor'>
      <textarea class="code" id='code4' name='code'>
      UPDATE tab SET campo1 = 'valore2' WHERE id = 1;
      </textarea>
      <button class="hidden"></button>
      </div>
    </section>

    <section class="slide">
      <h2>SQL SELECT</h2>
      <p>ma quello che ci interessa oggi è la query di ricerca</p>
      <div class ='wrapper editor'>
      <textarea class="code" id='code4' name='code'>
        SELECT id, campo1
        FROM tab
        WHERE campo2 > 100;
      </textarea>
      <button class="hidden"></button>

      <p><br/>I dialetti SQL sono molti e ci sono grandi differenze di dettaglio.
        Ma la struttura della sintassi principale per l'estrazione dei dati
         rimane praticamente la stessa per tutti i RDBMS.<br/>
       Oggi lavoreremo con SQlite, nella sua versione con estensioni spaziali
       <a href="http://www.gaia-gis.it/gaia-sins/">Spatialite</a>
       il cui sviluppo è open source ed è curato da
       <a href="mailto:a.furieri@lqt.it">Alessandro Furieri</a></p>
    </section>

    <section class="slide">
      <h2>L'ambiente di lavoro del Workshop</h2>
      <p>Per facilitare e velocizzare il workshop le esercitazioni sono completamente basate su un una versione speciale di Spatialite compilata per l'utilizzo da browser. Il database è residente nella memoria del browser,
        ma è facilmente scaricabile per l'utilizzo con QGIS per chi lo desidera:<a href="https://github.com/enricofer/spatiasql.js/blob/gh-pages/data/veneto.sqlite?raw=true">veneto.sqlite</a></p>
      <p>E' possibile una visualizzazione tabellare:</p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
      SELECT * FROM comuni
        </textarea>
        <button></button>
      </div>
      <p>o una visualizzazione su mappa: Le tabelle contengono un campo *geom* con le informazioni spaziali memorizzate in latitudine e longitudine (ETRS89 epsg:4258) e visualizzabili
        producendo una geometria <a href="https://it.wikipedia.org/wiki/GeoJSON">geojson</a><br/></p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
      SELECT AsGeoJSON(geom) AS geojson FROM comuni --geometria poligonale
      UNION
      SELECT AsGeoJSON(geom) AS geojson FROM strade --geometria lineare
      UNION
      SELECT AsGeoJSON(geom) AS geojson FROM fiumi --geometria lineare
      UNION
      SELECT AsGeoJSON(geom) AS geojson FROM centri --geometria puntuale
        </textarea>
        <button></button>
      </div>
    </section>


    <section class="slide">
      <h2>Funzioni SQlite di utilità generale</h2>
      <p>lista degli oggetti attualmente presenti nel database</p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
          SELECT *
          FROM sqlite_master
        </textarea>
        <button></button>
      </div>
      <p>Lista delle sole tabelle</p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
      SELECT *
      FROM sqlite_master
      WHERE type = 'table'
        </textarea>
        <button></button>
      </div>
      <p>Descrizione di una tabella</p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
      pragma table_info(comuni)
        </textarea>
        <button></button>
      </div>
    </section>

    <section class="slide">
      <h2>query di ricerca SELECT</h2>
      <p>Disponiamo delle seguenti tabelle, visualizzabili eseguendo le query:</p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
      SELECT * FROM comuni</textarea>
        <button></button>
      </div>

      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
      SELECT * FROM ferrovie</textarea>
        <button></button>
      </div>

      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
      SELECT * FROM fiumi</textarea>
        <button></button>
      </div>

      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
      SELECT * FROM centri</textarea>
        <button></button>
      </div>

      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
      SELECT * FROM pop --tabella senza geometria</textarea>
        <button></button>
      </div>

      <p>Alias:</p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT comune,provincia, istat AS codice
FROM comuni
        </textarea>
        <button></button>
      </div>
      <p>Query nidificate:<br/></p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT subquery.comune
FROM (
    SELECT * FROM comuni
) AS subquery
        </textarea>
        <button></button>
      </div>
    </section>

    <section class="slide">
      <h2>Clausola WHERE</h2>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT * FROM comuni
WHERE provincia = 'PD'
        </textarea>
        <button></button>
      </div>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT * FROM comuni
WHERE istat BETWEEN 28021 AND 28044
        </textarea>
        <button></button>
      </div>

      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT * FROM comuni
WHERE comune in ('Padova','Venezia','Treviso')
        </textarea>
        <button></button>
      </div>

      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT * FROM comuni
WHERE comune LIKE 'Ve%'
        </textarea>
        <button></button>
      </div>

      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT * FROM centri
WHERE NAMN1 = (SELECT comune FROM comuni WHERE istat = 28021)
        </textarea>
        <button></button>
      </div>

        <p>le condizioni in WHERE possono essere assemblate con AND, OR e negate con NOT
        <a href="https://www.techonthenet.com/sqlite/and_or.php">attenzione alla precedenza degli operatori</a></p>
      </section>

    <section class="slide">
      <h2>CAMPI CALCOLATI E ORDINAMENTO</h2>
      <p>calcolo ed imposizione del tipo (CAST):
      <a href="https://www.sqlite.org/lang_corefunc.html">Funzioni di manipolazione dei campi disponibili in SQlite</a></p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT comune, pop_totale, famiglie + convivenze as nuclei, cast(pop_totale AS float)/(famiglie + convivenze) as componenti_medi
FROM pop
        </textarea>
        <button></button>
      </div>
      <p>ordinamento crescente</p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT *
FROM pop
ORDER BY famiglie
        </textarea>
        <button></button>
      </div>
      <p>ordinamento decrescente</p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT *
FROM pop
ORDER BY pop_totale DESC
        </textarea>
        <button></button>
      </div>
      <p>ordinamento alfabetico multiplo</p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT *
FROM comuni
ORDER BY provincia,comune
        </textarea>
        <button></button>
      </div>
    </section>

    <section class="slide">
      <h2>JOIN - relazioni tra tabelle</h2>
      <p>La funzione fondamentale dei database relazionali è consentire l'aggregazione di dati tra due tabelle:
      <a href="https://it.wikipedia.org/wiki/Join_(SQL)">stabilendo una relazione tra campi</a></p>
      <p>Il tipo più semplice di join è il CROSS JOIN (senza condizioni):</p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT comuni.comune, pop.comune
FROM comuni,pop
WHERE comuni.istat = 28028
        </textarea>
        <button></button>
      </div>
      <p>L'INNER JOIN associa le righe delle tabelle che soddisfano una condizione, tralasciando le altre</p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT
  comuni.comune, pop.pop_totale,
  pop.pop_totale/comuni.area_ha AS densita
FROM comuni JOIN pop ON comuni.istat=pop.cod
ORDER BY densita DESC
        </textarea>
        <button></button>
      </div>
      <p>il LEFT JOIN associa a tutte le righe di una tabella le righe di un'altra solo se soddisfano una condizione, altrimenti NULL</p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT
  centri.NAMN1,
  comuni.comune
FROM centri LEFT JOIN comuni ON centri.NAMN1=comuni.comune
WHERE centri.NAMN1 LIKE 'Pe%'
        </textarea>
        <button></button>
      </div>
      <p>il RIGHT JOIN (meno usato) al contrario del LEFT JOIN, considera solo le righe di una tabella che soddisfano una condizione insieme a tutte le righe di un'altra tabella (non supportato da spatiasql.js)</p>
    </section>

    <section class="slide">
      <h2>Query di aggregazione e raggruppamento</h2>
      <p>Un'altra caratteristica delle query SELECT è la capacità di creare delle tabelle di sintesi da altre più complesse</p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT
	provincia,
  COUNT(comune) as num_comuni,
  SUM(area_ha) as area_ha,
  AVG(area_ha) as area_media
FROM comuni
GROUP BY provincia
        </textarea>
        <button></button>
      </div>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT
	provincia,
  COUNT(comuni.comune) as num_comuni, SUM(pop.pop_totale) as pop
FROM comuni JOIN pop ON comuni.istat = pop.cod
GROUP BY provincia
        </textarea>
        <button></button>
      </div>
      <a href="https://www.sqlite.org/lang_aggfunc.html">Funzione di aggregazione disponibili in SQlite</a>
    </section>

    <section class="slide">
      <h2>HAVING vs WHERE</h2>
      <p>il raggruppamento può essere basato su una condizione espressa dalla clausola HAVING. Esiste una sottile differenza tra WHERE ed HAVING. La prima direttiva agisce in fase di "fetching" dei dati dalla tabella selezionando solo quelli che soddisfano la condizione, mentre la seconda solo sul risultato del raggruppamento</p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT
	provincia,
  COUNT(comune) as num_comuni,
  SUM(area_ha) as area_prov,
  AVG(area_ha) as area_media
FROM comuni
GROUP BY provincia
HAVING area_prov > 300000
        </textarea>
        <button></button>
      </div>
      <p>La seguente query prima filtra i record e poi li raggruppa</p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT
	provincia,
  COUNT(comune) as num_comuni,
  SUM(area_ha) as area_ha,
  AVG(area_ha) as area_media
FROM comuni
WHERE area_ha > 5000
GROUP BY provincia
        </textarea>
        <button></button>
      </div>

    </section>

    <section class="slide">
      <h2>Funzioni geometriche di Spatialite</h2>
      <p>L'estensione spaziale di SQlite è Spatialite, e dispone di una serie molto completa di funzioni per la minipolazione di informazioni geografiche: <a href="http://www.gaia-gis.it/gaia-sins/spatialite-sql-4.2.0.html">Reference List</a></p>
      <p>Le funzioni basilari che utilizzeremo nel workshop sono le seguenti</p>
      <ul>
        <li>condizioni topologiche (condizioni spaziali): dentro, fuori, contenuto da, coincidente etc...</li>
        <li>manipolazione geometrica (aggregazione): unione, differenza, intersezione, buffer, generalizzazione</li>
        <li>misurazione geometrica: lunghezza, area, distanza</li>
        <li>estrazione geometrica: centroidi, linee di unione</li>
        <li>trasformazioni: riproiezioni, conversioni di formati geometrici</li>
      </ul>
    </section>

    <section class="slide">
      <h2>Il campo geometria</h2>
      <p>I tipi geometrici possono essere i seguenti:</p>
      <ul>
        <li>geometria puntuale</li>
        <li>geometria lineare</li>
        <li>geometria poligonale</li>
      </ul>
      <p>a loro volta possono essere semplici o multipli e raccoglibili in collezioni: <a href="https://www.gaia-gis.it/gaia-sins/spatialite-cookbook/html/wkt-wkb.html">riferimento</a></p>
      <p>L'informazione spaziale è contenuta in almeno un campo geometrico. Nelle tabelle del workshop il campo geografico è per convenzione il campo "geom", ma nulla vieta che possa avere un altro nome.<br/>Il formato di memorizzazione è binario, e quindi non visualizzabile "per gli umani" ma disponiamo di funzioni che permettono di trasformarlo in un formato più amichevole:</p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT
	geom,
  ST_AsText(geom) AS wkt,
  Hex(ST_AsBinary(geom)) AS wkb
FROM centri
        </textarea>
        <button></button>
      </div>
    </section>

    <section class="slide">
      <h2>Visualizzazione in mappa</h2>
      <p>Il risultato della query può essere visualizzato in mappa quando la tabella di output contiene un campo "geojson" contente le geometrie da visualizzare in formato <a href="http://geojson.org/">geojson:</a></p>
      <p>Il formato geojson è l'espressione testuale di un'oggetto javascript prodotta secondo lo standard "json" ed è facilmente "digeribile" dalle applicazioni web</p>
      <p>L'altra condizione perchè la geometria possa essere visualizzata correttamente nel visualizzatore è che il dato geografico deve essere espresso in gradi di latitudine e longitudine. Le tabelle predefinite sono nel formato ETRS89-epsg4258, sono quindi compatibili con il visualizzatore </p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT
  AsGeoJSON(
    ST_GeomFromText('LINESTRING(11 45,11 46,12 46,12 45, 11 45)')
  ) AS geojson
        </textarea>
        <button></button>
      </div>
    </section>

    <section class="slide">
      <h2>condizioni topologiche</h2>
      <p></p>
      <img src="https://www.google.com/url?sa=i&rct=j&q=&esrc=s&source=images&cd=&cad=rja&uact=8&ved=2ahUKEwih75zGjLrcAhUqzYUKHRPXCU4QjRx6BAgBEAU&url=https%3A%2F%2Fwww.gaia-gis.it%2Fspatialite-2.1%2FSpatiaLite-manual.html&psig=AOvVaw26NHPw-WeNgoDC5jLS0gaL&ust=1532602764157333">
      <p></p>
      <div class ='wrapper editor'>
        <textarea class="code" id='code' name='code'>
SELECT AsGeoJSON(geom) as geojson
FROM comuni
WHERE ST_Intersects(geom,ST_GeomFromText('POLYGON((11 45,11 46,12 46,12 45, 11 45))'))
        </textarea>
        <button></button>
      </div>
    </section>

    <section class="slide">
      <h2></h2>
      <p></p>
      <img src="">
      <p></p>
      <ul>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </section>

    <section class="slide">
      <h2></h2>
      <p></p>
      <img src="">
      <p></p>
      <ul>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </section>

    <section class="slide">
      <h2></h2>
      <p></p>
      <img src="">
      <p></p>
      <ul>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </section>
    <!-- End slides. -->

    <!-- Begin extension snippets. Add or remove as needed. -->

    <!-- deck.navigation snippet -->
    <div aria-role="navigation">
      <a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
      <a href="#" class="deck-next-link" title="Next">&#8594;</a>
    </div>

    <!-- deck.status snippet -->
    <p class="deck-status" aria-role="status">
      <span class="deck-status-current"></span>
      /
      <span class="deck-status-total"></span>
    </p>

    <!-- deck.goto snippet -->
    <form action="." method="get" class="goto-form">
      <label for="goto-slide">Go to slide:</label>
      <input type="text" name="slidenum" id="goto-slide" list="goto-datalist">
      <datalist id="goto-datalist"></datalist>
      <input type="submit" value="Go">
    </form>

    <!-- End extension snippets. -->
  </div>

<!-- Required JS files. -->
<script src="jquery.min.js"></script>
<script src="core/deck.core.js"></script>

<!-- Extension JS files. Add or remove as needed. -->
<script src="extensions/menu/deck.menu.js"></script>
<script src="extensions/goto/deck.goto.js"></script>
<script src="extensions/status/deck.status.js"></script>
<script src="extensions/navigation/deck.navigation.js"></script>
<script src="extensions/scale/deck.scale.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.26.0/codemirror.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.33.0/keymap/sublime.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.33.0/mode/sql/sql.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.33.0/addon/scroll/simplescrollbars.min.js'></script>

<!-- Initialize the deck. You can put this in an external file if desired. -->
<script>
  $(function() {
    $.deck('.slide');
  });

  window.onload = function () {
    var editors = {};
    var sqlareas = document.getElementsByClassName('code');
    for (var elem of sqlareas) {
        var editor = CodeMirror.fromTextArea(elem, {
            mode: 'text/x-sql',
            keyMap: 'sublime',
            //theme: 'neat',
            viewportMargin: 0,
            lineWrapping: true,
            scrollbarStyle: "null",
            addModeClass: true,
            //readOnly: "nocursor"
        });
        editor.target = elem.getAttribute('target')
        editors[elem.id] = editor
        var button = elem.nextSibling.nextSibling.nextSibling;
        console.log(button)
        button.editor = editor;
        button.addEventListener('click', function(event) {
            var url = 'https://enricofer.github.io/spatiasql.js/?wasm';
            console.log(event.target.editor.getValue());
            url += '&query='+event.target.editor.getValue();
            if (event.target.editor.getValue().toLowerCase().includes('geojson')){
                url += '&tab=m'
            } else {
                url += '&tab=t'
            }
            console.log(encodeURI(url));
            var win = window.open(encodeURI(url), '_blank');
            win.focus();
        });
    }
    console.log(editors)
}
</script>
</body>
</html>
